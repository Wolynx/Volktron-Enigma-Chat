<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<title>Volktronic Crypto</title>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getDatabase, ref, push, onChildAdded } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

const firebaseConfig = {
  apiKey: "BURAYA_API_KEY",
  authDomain: "volktron-chat.firebaseapp.com",
  databaseURL: "https://volktron-chat-default-rtdb.firebaseio.com",
  projectId: "volktron-chat",
  storageBucket: "volktron-chat.appspot.com",
  messagingSenderId: "XXXX",
  appId: "XXXX"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

window.db = db;
window.ref = ref;
window.push = push;
window.onChildAdded = onChildAdded;
</script>

<style>
body{background:#020617;color:#fff;font-family:sans-serif}
.hidden{display:none}
</style>
</head>

<body>

<div id="login">
  <input id="username" placeholder="Kullanıcı">
  <input id="room" placeholder="Oda">
  <button onclick="enterRoom()">GİR</button>
</div>

<div id="chat" class="hidden">
  <textarea id="message"></textarea>
  <button onclick="encrypt()">Gönder</button>
  <div id="log"></div>
</div>

<script>
let USER="", ROOM="", roomRef;
const encSel = new Set([1,2]); // test için sabit

function enterRoom(){
  USER=username.value;
  ROOM=room.value;
  if(!USER||!ROOM) return alert("Eksik");

  login.classList.add("hidden");
  chat.classList.remove("hidden");

  roomRef = ref(db, "rooms/" + ROOM);

  onChildAdded(roomRef, snap=>{
    const d = snap.val();
    log.innerHTML += `<div><b>${d.user}:</b> ${d.text}</div>`;
  });
}

function applyLayers(t){
  let o=t;
  encSel.forEach(k=>{
    o=[...o].map(c=>String.fromCharCode(c.charCodeAt(0)+k)).join("");
  });
  return o;
}

function encrypt(){
  if(!roomRef) return alert("Odaya girmedin");
  push(roomRef,{
    user:USER,
    text:applyLayers(message.value),
    time:Date.now()
  });
  message.value="";
}
</script>

</body>
</html>
