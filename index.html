<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
    <title>Volktronic | Ultra Secure</title>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Poppins:wght@600;800&display=swap" rel="stylesheet">

    <style>
        /* ========================================================
           1. YEPYENƒ∞ RENK PALETƒ∞ VE DEƒûƒ∞≈ûKENLER (PREMIUM SLATE)
           ======================================================== */
        :root {
            --bg-deep: #020617; /* Gece Mavisi / Siyah */
            --bg-surface: #0f172a; /* Mat Panel Rengi */
            --bg-input: #1e293b;
            --border-color: #334155;
            
            --brand-primary: #3b82f6; /* Elektrik Mavisi */
            --brand-gradient: linear-gradient(135deg, #3b82f6, #8b5cf6); /* Mavi - Mor Ge√ßi≈üi */
            --brand-hover: #2563eb;
            
            --text-main: #f8fafc;
            --text-muted: #94a3b8;
            --danger: #ef4444;
            --success: #10b981;
            
            --radius-sm: 8px;
            --radius-md: 16px;
            --radius-lg: 24px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; outline: none; }

        body {
            background-color: var(--bg-deep);
            color: var(--text-main);
            height: 100dvh; /* Mobilde g√ºvenli y√ºkseklik */
            display: flex; flex-direction: column;
            overflow: hidden;
        }

        .brand-font { font-family: 'Poppins', sans-serif; }
        .hidden { display: none !important; }

        /* ========================================================
           2. YEPYENƒ∞ FORM ELEMANLARI (KUSURSUZ VE MODERN)
           ======================================================== */
        button {
            border: none; border-radius: var(--radius-sm); font-weight: 600; font-size: 15px;
            cursor: pointer; transition: all 0.2s ease; display: flex; align-items: center; justify-content: center; gap: 8px;
        }
        button:active { transform: scale(0.97); }
        
        .btn-gradient { background: var(--brand-gradient); color: #fff; box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3); }
        .btn-gradient:hover { box-shadow: 0 6px 20px rgba(139, 92, 246, 0.4); }
        
        .btn-outline { background: transparent; border: 2px solid var(--border-color); color: var(--text-main); }
        .btn-outline:hover { border-color: var(--brand-primary); color: var(--brand-primary); }
        
        .btn-danger { background: rgba(239, 68, 68, 0.1); color: var(--danger); border: 1px solid rgba(239, 68, 68, 0.3); }

        input, textarea, select {
            width: 100%; padding: 16px; background: var(--bg-input); 
            border: 1px solid var(--border-color); border-radius: var(--radius-sm); 
            color: var(--text-main); font-size: 16px !important; /* MOBƒ∞L ZOOM ENGELƒ∞ */
            transition: border-color 0.2s;
        }
        input:focus, textarea:focus, select:focus { border-color: var(--brand-primary); }
        
        .input-label { display: block; font-size: 12px; color: var(--text-muted); margin-bottom: 6px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;}

        /* ========================================================
           3. Gƒ∞Rƒ∞≈û EKRANI (TAM ORTALI VE ZARƒ∞F)
           ======================================================== */
        #login-view {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; justify-content: center; align-items: center;
            background: radial-gradient(circle at 50% 0%, #1e1b4b 0%, var(--bg-deep) 70%);
            z-index: 50; padding: 20px;
        }
        .login-card {
            background: var(--bg-surface); width: 100%; max-width: 420px;
            padding: 40px 30px; border-radius: var(--radius-lg);
            border: 1px solid var(--border-color);
            box-shadow: 0 25px 50px -12px rgba(0,0,0,0.5);
        }
        .login-logo { font-size: 36px; text-align: center; margin-bottom: 5px; background: var(--brand-gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent;}
        .login-sub { text-align: center; color: var(--text-muted); font-size: 14px; margin-bottom: 30px; }

        /* ========================================================
           4. ANA APP ƒ∞SKELETƒ∞
           ======================================================== */
        #app-view {
            width: 100%; height: 100dvh; display: flex; flex-direction: column;
            background: var(--bg-deep);
        }

        /* YENƒ∞ √úST BAR */
        .app-header {
            background: var(--bg-surface); padding: 15px 20px; border-bottom: 1px solid var(--border-color);
            display: flex; justify-content: space-between; align-items: center; flex-shrink: 0;
        }
        .header-logo { font-size: 20px; font-weight: 800; color: #fff; display: flex; align-items: center; gap: 10px;}
        .header-info { display: flex; align-items: center; gap: 15px; font-size: 13px; font-weight: 500; color: var(--text-muted);}
        .live-badge { background: rgba(16, 185, 129, 0.1); color: var(--success); padding: 4px 10px; border-radius: 20px; font-size: 11px; font-weight: 700; border: 1px solid rgba(16,185,129,0.3); display: flex; align-items: center; gap: 6px;}
        .live-badge::before { content: ''; width: 6px; height: 6px; background: var(--success); border-radius: 50%; box-shadow: 0 0 8px var(--success); }

        /* ========================================================
           5. MASA√úST√ú (PC) ƒ∞√áƒ∞N YAN YANA PANELLER
           ======================================================== */
        .panels-container { display: flex; flex: 1; overflow: hidden; padding: 20px; gap: 20px; max-width: 1600px; margin: 0 auto; width: 100%; }
        
        .panel {
            background: var(--bg-surface); border: 1px solid var(--border-color);
            border-radius: var(--radius-md); display: flex; flex-direction: column; overflow: hidden;
        }
        .panel-side { width: 380px; flex-shrink: 0; }
        .panel-center { flex: 1; }

        .panel-title { padding: 16px 20px; border-bottom: 1px solid var(--border-color); font-weight: 700; font-size: 14px; background: rgba(0,0,0,0.2); }
        .panel-body { padding: 20px; overflow-y: auto; flex: 1; }
        .panel-body::-webkit-scrollbar { width: 6px; } .panel-body::-webkit-scrollbar-thumb { background: var(--border-color); border-radius: 10px; }

        /* ========================================================
           6. ƒ∞√áERƒ∞K Bƒ∞LE≈ûENLERƒ∞ (KATMANLAR, MESAJLAR)
           ======================================================== */
        /* Katman Se√ßimi */
        .layer-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; margin-bottom: 20px; }
        .layer-box {
            background: var(--bg-input); border: 1px solid var(--border-color); border-radius: var(--radius-sm);
            height: 48px; display: flex; align-items: center; justify-content: center; font-weight: 700; color: var(--text-muted); cursor: pointer; transition: 0.2s;
        }
        .layer-box.selected { background: var(--brand-primary); color: #fff; border-color: var(--brand-primary); }

        /* Ara√ß Butonlarƒ± */
        .tools-flex { display: flex; gap: 10px; margin-top: 15px; margin-bottom: 15px;}
        .tool-box { flex: 1; background: var(--bg-input); border: 1px solid var(--border-color); padding: 12px; text-align: center; border-radius: var(--radius-sm); font-size: 13px; font-weight: 600; cursor: pointer; transition: 0.2s;}
        .tool-box.active { background: rgba(59, 130, 246, 0.1); border-color: var(--brand-primary); color: var(--brand-primary); }
        .tool-box.recording { background: rgba(239, 68, 68, 0.1); border-color: var(--danger); color: var(--danger); }

        /* Sohbet Akƒ±≈üƒ± */
        #chat-feed { display: flex; flex-direction: column; gap: 15px; padding-bottom: 20px; }
        .msg-wrap { display: flex; flex-direction: column; max-width: 90%; }
        .msg-wrap.me { align-self: flex-end; }
        .msg-wrap.other { align-self: flex-start; }
        
        .msg-bubble {
            background: var(--bg-input); padding: 16px; border-radius: 16px; border: 1px solid var(--border-color);
        }
        .msg-wrap.me .msg-bubble { background: linear-gradient(145deg, #1e293b, #0f172a); border-bottom-right-radius: 2px; border-color: rgba(59, 130, 246, 0.3);}
        .msg-wrap.other .msg-bubble { border-bottom-left-radius: 2px; }
        
        .msg-info { display: flex; justify-content: space-between; font-size: 12px; margin-bottom: 10px; color: var(--text-muted); }
        .msg-wrap.me .msg-info strong { color: var(--brand-primary); }

        .cipher-box { background: #000; padding: 10px; border-radius: 6px; font-family: 'JetBrains Mono', monospace; font-size: 11px; word-break: break-all; max-height: 60px; overflow-y: auto; margin-bottom: 10px; color: #64748b; border: 1px solid #1e293b;}
        
        .msg-actions { display: flex; gap: 8px; }
        .msg-btn { flex: 1; padding: 8px; font-size: 12px; background: rgba(255,255,255,0.05); border: none; border-radius: 6px; color: #fff; cursor: pointer; }
        .msg-btn.primary { background: rgba(59, 130, 246, 0.2); color: var(--brand-primary); font-weight: bold;}
        
        .decrypted-area { margin-top: 15px; padding-top: 15px; border-top: 1px solid var(--border-color); font-size: 14px; line-height: 1.6; display: none; word-break: break-word;}

        #decrypt-result { margin-top: 20px; padding: 20px; background: var(--bg-input); border-left: 4px solid var(--brand-primary); border-radius: var(--radius-sm); min-height: 100px; font-size: 14px; word-break: break-word; }

        /* ========================================================
           7. MOBƒ∞L UYGULAMA Mƒ∞MARƒ∞Sƒ∞ (YEPYENƒ∞ NATIVE YAPI)
           ======================================================== */
        .mobile-tab-bar { display: none; }

        @media (max-width: 1024px) {
            /* PC D√ºzeni ƒ∞ptal */
            .panels-container { padding: 0; margin: 0; border-radius: 0; }
            .app-header { padding: 12px 15px; }
            .header-info span:not(.live-badge) { display: none; /* Mobilde yer kaplamasƒ±n */ }
            
            /* Dƒ∞KKAT: MOBƒ∞L PANELLER DISPLAY NONE ƒ∞LE KUSURSUZ Gƒ∞ZLENƒ∞R */
            .panel { 
                display: none !important; /* Standartta hepsi gizli */
                border: none; border-radius: 0; width: 100%; height: 100%;
            }
            .panel.active-mobile-tab { 
                display: flex !important; /* Sadece se√ßili olan g√∂r√ºn√ºr */
            }

            .panel-title { display: none; /* Alt barda ismi yazƒ±yor zaten */ }
            .panel-body { padding: 15px; padding-bottom: 80px; /* Alt bar bo≈üluƒüu */ }

            /* HARƒ∞KA NATIVE ALT MEN√ú */
            .mobile-tab-bar {
                display: flex; position: fixed; bottom: 0; left: 0; width: 100%;
                background: rgba(15, 23, 42, 0.95); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
                border-top: 1px solid var(--border-color);
                padding: 10px 10px 25px 10px; /* iOS home bar bo≈üluƒüu */
                justify-content: space-around; z-index: 1000;
            }
            .tab-item {
                background: transparent; border: none; color: var(--text-muted);
                display: flex; flex-direction: column; align-items: center; gap: 4px;
                font-size: 11px; font-weight: 600; cursor: pointer; padding: 5px 15px; border-radius: 12px;
            }
            .tab-icon { font-size: 20px; }
            .tab-item.active { color: var(--brand-primary); background: rgba(59, 130, 246, 0.1); }
            
            /* Mobil boyut optimizasyonlarƒ± */
            #message, #cipher { min-height: 80px; }
            .layer-box { height: 40px; font-size: 13px; }
            .msg-wrap { max-width: 95%; }
        }
    </style>
</head>
<body>

    <div id="login-view">
        <div class="login-card">
            <div class="brand-font login-logo">Volktronic.</div>
            <div class="login-sub">Premium Encrypted Workspace v10</div>

            <div style="margin-bottom: 15px;">
                <label class="input-label">Ajan Kimliƒüi</label>
                <input id="username" type="text" placeholder="√ñrn: Volkan" autocomplete="off">
            </div>
            
            <div style="display: flex; gap:10px; margin-bottom: 15px;">
                <div style="flex:2;">
                    <label class="input-label">Oda Kodu</label>
                    <input id="room" type="text" placeholder="Proje123" autocomplete="off">
                </div>
                <div style="flex:1;">
                    <label class="input-label">Oda PIN</label>
                    <input id="roomPin" type="password" placeholder="****" maxlength="4" autocomplete="off" style="text-align: center;">
                </div>
            </div>

            <div style="margin-bottom: 30px;">
                <label class="input-label">Master ≈ûifreleme Anahtarƒ±</label>
                <input id="secretKey" type="password" placeholder="Gizli Parola" autocomplete="off">
            </div>

            <button class="btn-gradient" style="width: 100%; padding: 16px;" onclick="app.login()">Sisteme Giri≈ü Yap</button>
        </div>
    </div>


    <div id="app-view" class="hidden">
        
        <header class="app-header">
            <div class="header-logo brand-font">Volktronic.</div>
            <div class="header-info">
                <span>Oda: <span id="info-room" style="color:var(--text-main);"></span></span>
                <span>Ajan: <span id="info-user" style="color:var(--text-main);"></span></span>
                <div class="live-badge"><span id="online-count">0</span> Aktif</div>
                <button class="btn-danger" style="padding: 6px 12px; font-size: 12px;" onclick="app.triggerPanic()">ƒ∞mha</button>
            </div>
        </header>

        <div class="panels-container">
            
            <div class="panel panel-side active-mobile-tab" id="tab-encrypt">
                <div class="panel-title">Veri ≈ûifreleme Terminali</div>
                <div class="panel-body">
                    <label class="input-label">G√ºvenlik Katmanlarƒ± (Sƒ±rayla Se√ßin)</label>
                    <div class="layer-grid" id="encrypt-layers"></div>
                    
                    <textarea id="input-message" placeholder="Aƒüa iletilecek metni buraya yazƒ±n..."></textarea>
                    
                    <div class="tools-flex">
                        <label for="input-image" class="tool-box" id="lbl-image">üñºÔ∏è G√∂rsel Se√ß</label>
                        <input type="file" id="input-image" accept="image/*" class="hidden">
                        <div class="tool-box" id="btn-mic" onclick="app.toggleMic()">üé§ Ses Kaydƒ±</div>
                    </div>

                    <select id="input-timer" style="margin-bottom: 20px;">
                        <option value="0">Kalƒ±cƒ± Mesaj (ƒ∞mha Yok)</option>
                        <option value="15">üî• 15 Saniyede ƒ∞mha Et</option>
                        <option value="60">üî• 60 Saniyede ƒ∞mha Et</option>
                    </select>

                    <button class="btn-gradient" style="width: 100%; padding: 16px;" onclick="app.sendData()">≈ûifrele ve G√∂nder üöÄ</button>
                </div>
            </div>

            <div class="panel panel-center" id="tab-chat">
                <div class="panel-title">Aƒü Akƒ±≈üƒ± (Canlƒ± ƒ∞leti≈üim)</div>
                <div class="panel-body" id="chat-scroller">
                    <div id="chat-feed"></div>
                    <div id="typing-status" style="font-size: 11px; color: var(--brand-primary); height: 15px; margin-top: 10px;"></div>
                </div>
            </div>

            <div class="panel panel-side" id="tab-decrypt">
                <div class="panel-title">Manuel Veri √á√∂z√ºc√º</div>
                <div class="panel-body">
                    <label class="input-label">G√∂ndericinin Katmanlarƒ±</label>
                    <div class="layer-grid" id="decrypt-layers"></div>
                    
                    <textarea id="input-cipher" placeholder="√á√∂z√ºlecek RAW veriyi buraya yapƒ±≈ütƒ±rƒ±n..." style="min-height: 100px;"></textarea>
                    
                    <button class="btn-outline" style="width: 100%; margin-top: 15px; padding: 14px;" onclick="app.decryptManual()">üîì Veriyi √á√∂z</button>

                    <div id="decrypt-result">Sonu√ß burada g√∂r√ºnt√ºlenecek...</div>
                </div>
            </div>

        </div>

        <div class="mobile-tab-bar">
            <button class="tab-item active" onclick="app.switchTab('tab-encrypt', this)">
                <span class="tab-icon">üîí</span> ≈ûifrele
            </button>
            <button class="tab-item" onclick="app.switchTab('tab-chat', this)">
                <span class="tab-icon">üí¨</span> Akƒ±≈ü
            </button>
            <button class="tab-item" onclick="app.switchTab('tab-decrypt', this)">
                <span class="tab-icon">üîì</span> √á√∂z√ºc√º
            </button>
        </div>

    </div>

    <script>
        const app = {
            db: null,
            user: "", roomPath: "", secret: "",
            ref: null,
            imgBase64: null, audioBase64: null,
            isRec: false, mediaRec: null, chunks: [],
            encLayers: new Set(), decLayers: new Set(),
            listenersOn: false,

            initFirebase: function() {
                try {
                    const cfg = { databaseURL: "https://volktron-chat-default-rtdb.firebaseio.com/" };
                    if (!firebase.apps.length) firebase.initializeApp(cfg);
                    this.db = firebase.database();
                } catch(e) {
                    console.error("DB Error:", e);
                }
            },

            // MOBƒ∞L SEKME MOTORU (Tamamen Display tabanlƒ±, kilitlenme yapmaz)
            switchTab: function(targetId, btnEl) {
                if(window.innerWidth > 1024) return;
                
                if (document.activeElement) document.activeElement.blur(); // Klavye kapat

                document.querySelectorAll('.panel').forEach(p => p.classList.remove('active-mobile-tab'));
                document.getElementById(targetId).classList.add('active-mobile-tab');
                
                if(btnEl) {
                    document.querySelectorAll('.tab-item').forEach(b => b.classList.remove('active'));
                    btnEl.classList.add('active');
                }

                if(targetId === 'tab-chat') {
                    setTimeout(() => {
                        const s = document.getElementById("chat-scroller");
                        if(s) s.scrollTop = s.scrollHeight;
                    }, 50);
                }
            },

            buildLayers: function() {
                const create = (id, setObj) => {
                    const cont = document.getElementById(id);
                    for (let i = 1; i <= 10; i++) {
                        const b = document.createElement("div");
                        b.className = "layer-box"; b.innerHTML = i < 10 ? '0'+i : i;
                        b.onclick = function() {
                            if (setObj.has(i)) setObj.delete(i); else setObj.add(i);
                            this.classList.toggle("selected");
                        };
                        cont.appendChild(b);
                    }
                };
                create("encrypt-layers", this.encLayers);
                create("decrypt-layers", this.decLayers);
            },

            login: function() {
                this.user = document.getElementById("username").value.trim();
                const r = document.getElementById("room").value.trim();
                const p = document.getElementById("roomPin").value.trim();
                this.secret = document.getElementById("secretKey").value.trim();

                if (!this.user || !r || !this.secret || !p) { alert("L√ºtfen t√ºm alanlarƒ± doldurun."); return; }
                if (!this.db) { alert("Sistem √ßevrimdƒ±≈üƒ±. Sayfayƒ± yenileyin."); return; }

                const hash = CryptoJS.MD5(r + "_" + p).toString();
                this.roomPath = r + "_" + hash.substring(0, 10);

                document.getElementById("info-user").textContent = this.user;
                document.getElementById("info-room").textContent = r;

                document.getElementById("login-view").classList.add("hidden");
                document.getElementById("app-view").classList.remove("hidden");

                if (!this.listenersOn) { this.startNetwork(); this.listenersOn = true; }
            },

            startNetwork: function() {
                const presRef = this.db.ref("rooms/" + this.roomPath + "/presence").push();
                presRef.set(this.user); presRef.onDisconnect().remove();

                this.db.ref("rooms/" + this.roomPath + "/presence").on('value', snap => {
                    document.getElementById('online-count').innerText = Object.keys(snap.val() || {}).length;
                });

                this.db.ref("rooms/" + this.roomPath + "/typing").on('value', snap => {
                    const data = snap.val() || {}; 
                    const writers = Object.keys(data).filter(u => u !== this.user);
                    document.getElementById("typing-status").textContent = writers.length > 0 ? `${writers.join(", ")} yazƒ±yor...` : "";
                });

                this.ref = this.db.ref("rooms/" + this.roomPath + "/messages");
                this.ref.on('child_added', snap => this.renderMsg(snap));
                this.ref.on('child_removed', snap => this.removeMsg(snap.key));
            },

            renderMsg: function(snap) {
                const d = snap.val() || {}; const key = snap.key;
                const sender = d.user || "Ajan"; const txt = d.text || "";
                const time = d.time ? new Date(d.time).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : "--:--";

                // Telefon kasmamasƒ± i√ßin uzun RAW veriyi HTML'de kƒ±rpƒ±yoruz
                let rawDisp = txt.length > 80 ? txt.substring(0, 80) + "..." : txt;

                const wrap = document.createElement("div");
                wrap.id = "msg-" + key;
                wrap.className = "msg-wrap " + (sender === this.user ? "me" : "other");
                
                wrap.innerHTML = `
                    <div class="msg-bubble">
                        <div class="msg-info"><strong>${sender}</strong><span>${time}</span></div>
                        <div class="cipher-box">${rawDisp}</div>
                        <div class="msg-actions">
                            <button class="msg-btn" onclick="navigator.clipboard.writeText('${txt}')">Kopyala</button>
                            <button class="msg-btn" onclick="app.passToDec('${txt}')">Aktar</button>
                            <button class="msg-btn primary" id="btn-dec-${key}">√á√∂z</button>
                        </div>
                        <div class="decrypted-area" id="view-${key}"></div>
                    </div>
                `;

                wrap.querySelector(`#btn-dec-${key}`).onclick = () => {
                    const p = this.cryptoCore.decrypt(txt, this.secret, this.decLayers);
                    const v = wrap.querySelector(`#view-${key}`);
                    const r = wrap.querySelector(".cipher-box");
                    const a = wrap.querySelector(".msg-actions");

                    if (p.startsWith("HATA")) { alert("Hata: Katman sƒ±ralamasƒ± veya parola yanlƒ±≈ü."); } 
                    else {
                        if (p.startsWith("IMG||")) {
                            v.innerHTML = `<img src="${p.split("||")[1]}" style="width:100%; border-radius:8px; margin-bottom:8px;"><div>${p.split("||")[2]||""}</div>`;
                        } else if (p.startsWith("AUDIO||")) {
                            v.innerHTML = `<audio controls src="${p.split("||")[1]}" style="width:100%; height:40px; margin-bottom:8px;"></audio><div>${p.split("||")[2]||""}</div>`;
                        } else {
                            v.innerHTML = p.replace("TXT||", "");
                        }
                        v.style.display = "block"; r.style.display = "none"; a.style.display = "none";
                        if (d.burn > 0) this.startBurn(d.burn, key, wrap.querySelector('.msg-bubble'));
                    }
                };

                document.getElementById("chat-feed").appendChild(wrap);
                const sc = document.getElementById("chat-scroller");
                if(sc) sc.scrollTop = sc.scrollHeight;
            },

            removeMsg: function(key) {
                const el = document.getElementById("msg-" + key);
                if(el) { el.innerHTML = `<div style="text-align:center; font-size:11px; color:var(--text-muted);">Mesaj imha edildi.</div>`; setTimeout(() => el.remove(), 2000); }
            },

            startBurn: function(sec, key, el) {
                let t = sec; const d = document.createElement("div");
                d.style.color = "var(--danger)"; d.style.fontSize = "11px"; d.style.marginTop = "10px"; d.style.textAlign = "right";
                el.appendChild(d);
                const i = setInterval(() => {
                    d.innerHTML = `üî• ${t}s`; t--;
                    if (t < 0) { clearInterval(i); this.db.ref("rooms/" + this.roomPath + "/messages/" + key).remove(); }
                }, 1000);
            },

            passToDec: function(txt) {
                document.getElementById('input-cipher').value = txt;
                // Mobilde √ß√∂z√ºc√º paneline y√∂nlendir, Butonlarƒ± g√ºncelle
                if(window.innerWidth <= 1024) {
                    const b = Array.from(document.querySelectorAll('.tab-item')).find(el => el.getAttribute('onclick').includes('tab-decrypt'));
                    this.switchTab('tab-decrypt', b);
                }
            },

            cryptoCore: {
                encrypt: function(text, key, layersSet) {
                    let enc = text; let arr = [...layersSet].sort((a, b) => a - b);
                    if (arr.length === 0) return CryptoJS.AES.encrypt(enc, key).toString();
                    arr.forEach(l => { enc = CryptoJS.AES.encrypt(enc, key + "_L" + l).toString(); });
                    return enc;
                },
                decrypt: function(text, key, layersSet) {
                    let dec = text; let arr = [...layersSet].sort((a, b) => b - a);
                    try {
                        if (arr.length === 0) {
                            let b = CryptoJS.AES.decrypt(dec, key);
                            let r = b.toString(CryptoJS.enc.Utf8); if(!r) throw Error(); return r;
                        }
                        arr.forEach(l => {
                            let b = CryptoJS.AES.decrypt(dec, key + "_L" + l);
                            dec = b.toString(CryptoJS.enc.Utf8); if(!dec) throw Error();
                        });
                        return dec;
                    } catch (e) { return "HATA"; }
                }
            },

            sendData: function() {
                if (!this.db) return;
                const i = document.getElementById("input-message"); const t = i.value.trim();
                const burn = parseInt(document.getElementById("input-timer").value);

                if (!t && !this.imgBase64 && !this.audioBase64) { alert("G√∂nderilecek veri yok."); return; }

                let p = this.imgBase64 ? ("IMG||" + this.imgBase64 + "||" + t) : (this.audioBase64 ? ("AUDIO||" + this.audioBase64 + "||" + t) : ("TXT||" + t));
                const encP = this.cryptoCore.encrypt(p, this.secret, this.encLayers);
                
                this.ref.push({ user: this.user, text: encP, time: Date.now(), burn: burn });

                i.value = ""; this.imgBase64 = null; this.audioBase64 = null;
                document.getElementById("lbl-image").innerHTML = "üñºÔ∏è G√∂rsel Se√ß"; document.getElementById("lbl-image").classList.remove("active");
                document.getElementById("btn-mic").innerHTML = "üé§ Ses Kaydƒ±"; document.getElementById("btn-mic").classList.remove("active");

                if(window.innerWidth <= 1024) {
                    const b = Array.from(document.querySelectorAll('.tab-item')).find(el => el.getAttribute('onclick').includes('tab-chat'));
                    this.switchTab('tab-chat', b);
                }
            },

            decryptManual: function() {
                const raw = document.getElementById("input-cipher").value.trim();
                const res = document.getElementById("decrypt-result");
                if (!raw) { res.textContent = "Veri girin."; return; }

                const p = this.cryptoCore.decrypt(raw, this.secret, this.decLayers);
                if (p.startsWith("HATA")) {
                    res.innerHTML = "Sistem Reddi: Veri √ß√∂z√ºlemedi. Yanlƒ±≈ü katman/parola."; res.style.color = "var(--danger)";
                } else {
                    res.innerHTML = p.startsWith("IMG||") || p.startsWith("AUDIO||") ? "[Bu bir medya dosyasƒ±dƒ±r, Aƒü Akƒ±≈üƒ± sayfasƒ±ndan √ß√∂z√ºn]" : p.replace("TXT||", "");
                    res.style.color = "var(--brand-primary)";
                }
            },

            toggleMic: async function() {
                const btn = document.getElementById("btn-mic");
                if (!this.isRec) {
                    try {
                        const s = await navigator.mediaDevices.getUserMedia({ audio: true });
                        this.mediaRec = new MediaRecorder(s); this.chunks = [];
                        this.mediaRec.ondataavailable = e => { if (e.data.size > 0) this.chunks.push(e.data); };
                        this.mediaRec.onstop = () => {
                            const b = new Blob(this.chunks, { type: 'audio/webm' });
                            const r = new FileReader(); r.readAsDataURL(b);
                            r.onloadend = () => {
                                this.audioBase64 = r.result; this.imgBase64 = null; 
                                btn.innerHTML = "Ses Hazƒ±r ‚úì"; btn.classList.remove("recording"); btn.classList.add("active");
                            };
                        };
                        this.mediaRec.start(); this.isRec = true;
                        btn.innerHTML = "Kaydediliyor üõë"; btn.classList.add("recording");
                    } catch (e) { alert("Mikrofon izni yok."); }
                } else { this.mediaRec.stop(); this.isRec = false; }
            },

            triggerPanic: function() {
                if (confirm("Dƒ∞KKAT! T√ºm sistem ve veritabanƒ± imha edilecek. Onaylƒ±yor musunuz?")) {
                    if(this.db) this.db.ref("rooms/" + this.roomPath).remove();
                    document.body.innerHTML = `<div style="display:flex; height:100dvh; align-items:center; justify-content:center; color:red; font-size:24px; font-weight:bold; background:#000;">Sƒ∞STEM ƒ∞MHA EDƒ∞LDƒ∞</div>`;
                }
            }
        };

        // Ba≈ülatƒ±cƒ±lar
        app.initFirebase();
        app.buildLayers();

        // Performanslƒ± Yazƒ±yor Eventi
        let tTmr; let lTime = 0;
        document.getElementById("input-message").addEventListener("input", () => {
            if(!app.roomPath || !app.db) return;
            const n = Date.now();
            if(n - lTime > 1500) { app.db.ref("rooms/" + app.roomPath + "/typing/" + app.user).set(n); lTime = n; }
            clearTimeout(tTmr);
            tTmr = setTimeout(() => app.db.ref("rooms/" + app.roomPath + "/typing/" + app.user).remove(), 2500);
        });

        // Dosya input baƒülantƒ±sƒ±
        document.getElementById("input-image").addEventListener("change", function(e) {
            const f = e.target.files[0]; const l = document.getElementById("lbl-image");
            if (!f) return;
            if (f.size > 1.5 * 1024 * 1024) { alert("Max 1.5MB"); this.value = ""; return; }
            const r = new FileReader();
            r.onload = function(evt) {
                app.imgBase64 = evt.target.result; app.audioBase64 = null; 
                l.innerHTML = "G√∂rsel Hazƒ±r ‚úì"; l.classList.add("active");
            };
            r.readAsDataURL(f);
        });
    </script>
</body>
</html>
